<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShopSmart | Product Inventory</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 0;
      }
      header {
        background: #007bff;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        margin: 0;
        font-size: 22px;
      }
      header a {
        color: white;
        text-decoration: none;
      }
      .filter-bar {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .filter-bar input,
      .filter-bar select,
      .filter-bar button {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      .filter-bar button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      .filter-bar button:hover {
        background: #0056b3;
      }
      .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }
      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
        padding: 15px;
        transition: transform 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .card:hover {
        transform: translateY(-3px);
      }
      .card h3 {
        margin: 0 0 10px;
        font-size: 18px;
        color: #333;
      }
      .card p {
        margin: 4px 0;
        font-size: 14px;
        color: #555;
      }
      .price {
        color: #28a745;
        font-weight: bold;
        margin-top: 10px;
        font-size: 16px;
      }
      .btn {
        margin-top: 10px;
        padding: 8px 12px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn:hover {
        background: #218838;
      }
      .error {
        text-align: center;
        color: red;
        margin-top: 15px;
      }
      footer {
        text-align: center;
        padding: 10px;
        background: #007bff;
        color: white;
        margin-top: 30px;
      }
      #cart {
        position: fixed;
        top: 0;
        right: -400px;
        width: 350px;
        height: 80%;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      #cart.open {
        right: 0;
      }
      #cart h2 {
        margin-top: 0;
      }
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ccc;
        padding: 5px 0;
      }
      .cart-item button {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 3px 6px;
        cursor: pointer;
      }
      .cart-item button:hover {
        background: #0056b3;
      }
      .cart-footer {
        margin-top: auto;
        text-align: center;
      }
      .cart-footer button {
        background: #28a745;
        border: none;
        padding: 10px 15px;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      .cart-footer button:hover {
        background: #218838;
      }
      .cart-total {
        margin: 10px 0;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ShopSmart Inventory</h1>
      <div>
        <button onclick="toggleCart()">
          üõí Cart (<span id="cartCount">0</span>)
        </button>
        <a href="/login" onclick="logout()">Logout</a>
      </div>
    </header>

    <div class="filter-bar">
      <input type="text" id="search" placeholder="Search product..." />
      <select id="category">
        <option value="">All Categories</option>
        <option value="Electronics">Electronics</option>
        <option value="Home">Home</option>
        <option value="Fashion">Fashion</option>
        <option value="Grocery">Grocery</option>
      </select>
      <select id="sort">
        <option value="createdAt-desc">Newest</option>
        <option value="price-asc">Price: Low to High</option>
        <option value="price-desc">Price: High to Low</option>
      </select>
      <button id="filterBtn">Filter</button>
    </div>

    <div class="container">
      <div id="errorMsg" class="error"></div>
      <div class="grid" id="productGrid"></div>
    </div>

    <div id="cart">
      <h2>Your Cart</h2>
      <div id="cartItems"></div>
      <div class="cart-footer">
        <p class="cart-total">Total: ‚Çπ<span id="cartTotal">0</span></p>
        <button onclick="checkout()">Place Order</button>
      </div>
    </div>

    <footer>¬© 2025 ShopSmart Inventory System</footer>

    <script>
      const token = localStorage.getItem("token");
      if (!token) window.location.href = "/login";

      const productGrid = document.getElementById("productGrid");
      const errorMsg = document.getElementById("errorMsg");
      const searchInput = document.getElementById("search");
      const categorySelect = document.getElementById("category");
      const sortSelect = document.getElementById("sort");
      const filterBtn = document.getElementById("filterBtn");

      let cart = [];

      async function fetchProducts() {
        errorMsg.textContent = "";
        productGrid.innerHTML = "<p>Loading products...</p>";

        const q = searchInput.value.trim();
        const category = categorySelect.value;
        const [sortBy, sortDir] = sortSelect.value.split("-");

        const url = new URL("/api/products", window.location.origin);
        if (q) url.searchParams.append("q", q);
        if (category) url.searchParams.append("category", category);
        url.searchParams.append("sortBy", sortBy);
        url.searchParams.append("sortDir", sortDir);

        try {
          const res = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          if (!res.ok)
            throw new Error(data.message || "Failed to fetch products.");

          if (!data.data || data.data.length === 0) {
            productGrid.innerHTML =
              '<p style="text-align:center;">No products found.</p>';
            return;
          }

          productGrid.innerHTML = data.data
            .map(
              (p) => `
              <div class="card">
                <h3>${p.name}</h3>
                <p><strong>Model:</strong> ${p.modelName}</p>
                <p><strong>Company:</strong> ${p.company}</p>
                <p><strong>Category:</strong> ${p.category}</p>
                <p><strong>Quantity:</strong> ${p.quantity}</p>
                <p class="price">‚Çπ${p.price}</p>
                <button class="btn" onclick="addToCart('${p._id}', '${p.name}', ${p.price})">üõí Add to Cart</button>
              </div>`
            )
            .join("");
        } catch (err) {
          errorMsg.textContent = err.message;
          productGrid.innerHTML = "";
        }
      }

      function addToCart(id, name, price) {
        const existing = cart.find((item) => item.id === id);
        if (existing) existing.quantity++;
        else cart.push({ id, name, price, quantity: 1 });
        renderCart();
      }

      function renderCart() {
        const cartDiv = document.getElementById("cartItems");
        const cartCount = document.getElementById("cartCount");
        const cartTotal = document.getElementById("cartTotal");

        if (cart.length === 0) {
          cartDiv.innerHTML = "<p>No items in cart.</p>";
          cartTotal.textContent = "0";
          cartCount.textContent = "0";
          return;
        }

        cartDiv.innerHTML = cart
          .map(
            (item) => `
            <div class="cart-item">
              <span>${item.name}</span>
              <div>
                <button onclick="updateQty('${item.id}', -1)">-</button>
                <span>${item.quantity}</span>
                <button onclick="updateQty('${item.id}', 1)">+</button>
              </div>
              <span>‚Çπ${item.price * item.quantity}</span>
            </div>`
          )
          .join("");

        cartCount.textContent = cart.reduce((sum, i) => sum + i.quantity, 0);
        cartTotal.textContent = cart.reduce(
          (sum, i) => sum + i.price * i.quantity,
          0
        );
      }

      function updateQty(id, delta) {
        const item = cart.find((i) => i.id === id);
        if (!item) return;
        item.quantity += delta;
        if (item.quantity <= 0) cart = cart.filter((i) => i.id !== id);
        renderCart();
      }

      async function checkout() {
        if (cart.length === 0) return alert("Your cart is empty!");
        const address = prompt("Enter your delivery address:");
        if (!address) return alert("Address is required.");

        const orderData = {
          items: cart.map((i) => ({ product: i.id, quantity: i.quantity })),
          address,
        };

        try {
          const res = await fetch("/api/order", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message);
          alert("‚úÖ Order placed successfully!");
          cart = [];
          renderCart();
          toggleCart();
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      }

      function toggleCart() {
        document.getElementById("cart").classList.toggle("open");
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login";
      }

      filterBtn.addEventListener("click", fetchProducts);
      window.addEventListener("DOMContentLoaded", fetchProducts);
    </script>
  </body>
</html>
